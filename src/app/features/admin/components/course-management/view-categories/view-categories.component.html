<!-- view-categories.component.html -->
<div class="min-h-screen bg-white">
  <!-- Top bar -->
  <div class="px-4 pt-4 sm:px-5 sm:pt-5">
    <button type="button" (click)="goBack()" class="cursor-pointer p-1" aria-label="Back">
      <img src="/assets/admin/backicon.svg" alt="Back" class="h-4 w-4" />
    </button>
  </div>

  <!-- Header -->
  <div class="px-4 sm:px-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between sm:gap-4">
      <div class="ml-1 sm:ml-2">
        <div class="text-[18px] font-semibold text-gray-900 sm:text-lg">Manage Categories</div>
        <div class="mt-0.5 text-[11px] text-gray-500">
          Organize courses using S.T.E.A.M framework
        </div>
      </div>

      <button type="button" (click)="addCategory()"
        class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#923D8C] px-4 text-[12px] font-semibold text-white hover:bg-[#7a3270] sm:h-8 sm:w-auto sm:px-3">
        <span class="text-[14px] leading-none">+</span>
        Add Category
      </button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="mt-4 px-4 sm:px-6">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <!-- Search -->
      <div class="relative w-full sm:max-w-[420px]">
        <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
          <svg viewBox="0 0 24 24" class="h-3.5 w-3.5" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" />
            <path d="M16.6 16.6 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </span>

        <input [(ngModel)]="search" type="text" placeholder="Search categories..."
          class="h-9 w-full rounded-sm border border-gray-300 bg-white pl-9 pr-3 text-[12px] text-gray-700 outline-none placeholder:text-gray-400 sm:h-8 sm:text-[11px]" />
      </div>

      <!-- Right controls -->
      <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center text-gray-700">
        <select [(ngModel)]="statusFilter"
          class="h-9 w-full cursor-pointer rounded-sm border border-gray-300 bg-white px-2 text-[12px] outline-none sm:h-8 sm:w-[140px] sm:text-[11px]">
          <option>All Status</option>
          <option>Active</option>
          <option>Inactive</option>
        </select>

        <button type="button" (click)="moreFilters()"
          class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-sm border border-gray-300 bg-white px-3 text-[12px] font-semibold hover:bg-gray-50 sm:h-8 sm:w-auto sm:text-[11px]">
          <svg viewBox="0 0 24 24" class="h-4 w-4 text-gray-600" fill="none">
            <path d="M4 6h16M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          More Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Divider -->
  <div class="mt-4 h-px w-full bg-gray-100"></div>

  <!-- Table -->
  <div class="px-4 pb-10 sm:px-6">
    <div class="mt-4 overflow-hidden rounded-[4px] border border-gray-100 bg-white">
      <div class="overflow-x-auto">
        <table class="w-full min-w-[820px]">
          <thead class="bg-[#E5E7EB]">
            <tr>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Category
              </th>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Description
              </th>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Status
              </th>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Subcategories
              </th>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Creation Date
              </th>
              <th scope="col"
                class="px-5 py-3 text-left text-[11px] font-semibold text-gray-600 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            <tr *ngFor="let r of filteredRows; trackBy: trackById" class="hover:bg-gray-50/60 transition-colors">
              <!-- Category -->
              <td class="px-5 py-4">
                <div class="flex items-center gap-3">
                  <div class="flex h-8 w-8 items-center justify-center rounded bg-[#D9D9D933] shrink-0 overflow-hidden">
                    <img [src]="getIconUrl(r.icon)" [alt]="r.name" class="h-full w-full object-cover" loading="lazy" />
                  </div>
                  <div class="text-[12px] font-semibold text-gray-900">{{ r.name }}</div>
                </div>
              </td>

              <!-- Description -->
              <td class="px-5 py-4">
                <div class="max-w-[320px] truncate text-[11px] text-gray-500">
                  {{ r.description }}
                </div>
              </td>

              <!-- Status -->
              <td class="px-5 py-4">
                <span class="inline-flex rounded-full px-2.5 py-0.5 text-[10px] font-semibold"
                  [ngClass]="r.status === 'Active' ? 'bg-[#923D8C33] text-[#923D8C]' : 'bg-red-50 text-red-600'">
                  {{ r.status }}
                </span>
              </td>

              <!-- Subcategories -->
              <td class="px-5 py-4">
                <div class="text-[12px] font-medium text-gray-700">{{ r.subcategories }}</div>
              </td>

              <!-- Creation date -->
              <td class="px-5 py-4">
                <div class="text-[11px] text-gray-500">{{ r.createdAt }}</div>
              </td>

              <!-- Actions -->
              <td class="px-5 py-4">
                <div class="flex items-center gap-4 whitespace-nowrap">
                  <button type="button" (click)="viewRow(r)" class="group" aria-label="view">
                    <img src="/assets/admin/course-management/view.svg" alt="view"
                      class="h-4 w-4 opacity-50 group-hover:opacity-100 transition-opacity" loading="lazy" />
                  </button>

                  <button type="button" (click)="editRow(r)" class="group" aria-label="edit">
                    <img src="/assets/admin/course-management/edit.svg" alt="edit"
                      class="h-4 w-4 opacity-50 group-hover:opacity-100 transition-opacity" loading="lazy" />
                  </button>

                  <button type="button" (click)="deleteRow(r)" class="group" aria-label="delete">
                    <img src="/assets/admin/course-management/delete.svg" alt="delete"
                      class="h-4 w-4 opacity-50 group-hover:opacity-100 transition-opacity" loading="lazy" />
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="filteredRows.length === 0">
              <td colspan="6" class="px-5 py-12 text-center text-[12px] text-gray-400">
                No categories found matching your criteria
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between border-t border-gray-100 bg-white px-5 py-3"
        *ngIf="pagination.total > 0">
        <p class="text-[11px] text-gray-500">
          Showing <span class="font-semibold text-gray-900">{{ (pagination.page - 1) * pagination.limit + 1 }}</span> to
          <span class="font-semibold text-gray-900">{{ Math.min(pagination.page * pagination.limit, pagination.total)
            }}</span> of
          <span class="font-semibold text-gray-900">{{ pagination.total }}</span> categories
        </p>

        <nav class="flex items-center gap-1" aria-label="Pagination">
          <button type="button" (click)="changePage(pagination.page - 1)"
            [disabled]="pagination.page === 1 || isLoading"
            class="flex h-7 w-7 items-center justify-center rounded border border-gray-200 bg-white text-gray-400 hover:bg-gray-50 disabled:opacity-50">
            <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
              <path fill-rule="evenodd"
                d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z"
                clip-rule="evenodd" />
            </svg>
          </button>

          <div class="flex items-center gap-1 mx-1.5">
            <button type="button" *ngFor="let p of pages" (click)="changePage(p)"
              [class]="p === pagination.page ? 'bg-[#923D8C] text-white border-[#923D8C]' : 'border-gray-200 text-gray-600 hover:bg-gray-50'"
              class="flex h-7 w-7 items-center justify-center rounded border text-[11px] font-semibold transition-all">
              {{ p }}
            </button>
          </div>

          <button type="button" (click)="changePage(pagination.page + 1)"
            [disabled]="pagination.page === pagination.totalPages || isLoading"
            class="flex h-7 w-7 items-center justify-center rounded border border-gray-200 bg-white text-gray-400 hover:bg-gray-50 disabled:opacity-50">
            <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
              <path fill-rule="evenodd"
                d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
                clip-rule="evenodd" />
            </svg>
          </button>
        </nav>
      </div>
    </div>
  </div>

  <!-- ===================== VIEW MODAL ===================== -->
  <div *ngIf="isViewOpen && activeRow"
    class="fixed inset-0 z-999 flex items-center justify-center bg-black/30 p-4 backdrop-blur-[1px]"
    (click)="closeView()">
    <div class="flex w-full max-w-[340px] flex-col overflow-hidden rounded-lg border border-gray-200 bg-white shadow-xl"
      (click)="$event.stopPropagation()">
      <div class="flex items-center justify-between border-b border-gray-100 px-5 py-3">
        <h3 class="text-[13px] font-bold text-gray-900">Category Details</h3>
        <button type="button" (click)="closeView()" class="text-gray-400 hover:text-gray-600">×</button>
      </div>

      <div class="flex-1 overflow-y-auto px-5 py-4">
        <div class="flex items-start gap-4">
          <div class="flex h-11 w-11 items-center justify-center rounded bg-[#D9D9D933] shrink-0">
            <img [src]="getIconUrl(activeRow.icon)" [alt]="activeRow.name" class="h-full w-full object-cover" />
          </div>

          <div class="min-w-0">
            <h4 class="text-[12px] font-bold text-gray-900">{{ activeRow.name }}</h4>
            <span
              class="mt-0.5 inline-flex rounded-full bg-[#923D8C33] px-2 py-0.5 text-[9px] font-bold text-[#923D8C]">
              {{ activeRow.status }}
            </span>
          </div>
        </div>

        <div class="mt-4">
          <p class="text-[11px] leading-relaxed text-gray-500">
            {{ activeRow.description }}
          </p>
        </div>

        <div class="mt-6 space-y-4">
          <div>
            <h5 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Subcategories</h5>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let s of viewSubcategoryNames"
                class="px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ s }}
              </span>
            </div>
          </div>

          <div>
            <h5 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Course Levels</h5>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let lv of viewLevelNames"
                class="px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ lv }}
              </span>
            </div>
          </div>

          <div>
            <h5 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Age Groups</h5>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let ag of viewAgeGroupNames"
                class="px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ ag }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="p-5">
        <button (click)="editFromView()"
          class="w-full py-2 rounded-sm bg-[#923D8C] text-white text-[11px] font-bold hover:bg-[#7a3270] transition-colors">
          Edit Category
        </button>
      </div>
    </div>
  </div>

  <!-- ===================== DELETE MODAL ===================== -->
  <div *ngIf="isDeleteOpen && activeRow" class="fixed inset-0 z-999 flex items-center justify-center bg-black/30 p-4"
    (click)="closeDelete()">
    <div class="w-full max-w-[480px] rounded-lg bg-white shadow-xl p-6 text-center" (click)="$event.stopPropagation()">
      <h3 class="text-[14px] font-bold text-gray-900">Do you want to delete this category?</h3>

      <div class="mt-8 flex justify-center gap-3">
        <button type="button" (click)="closeDelete()" [disabled]="isLoading"
          class="h-9 min-w-[110px] rounded-full bg-[#E5E7EB] text-[11px] font-bold text-gray-700 hover:bg-gray-200 disabled:opacity-50">
          Cancel
        </button>
        <button type="button" (click)="confirmDelete()" [disabled]="isLoading"
          class="h-9 min-w-[110px] rounded-full bg-[#923D8C] text-white text-[11px] font-bold hover:bg-[#7a3270] disabled:opacity-50">
          <ng-container *ngIf="isLoading">Deleting...</ng-container>
          <ng-container *ngIf="!isLoading">Confirm</ng-container>
        </button>
      </div>
    </div>
  </div>

  <!-- ===================== ADD/EDIT MODAL ===================== -->
  <div *ngIf="isAddCategoryOpen"
    class="fixed inset-0 z-999 flex items-center justify-center bg-black/30 p-4 backdrop-blur-[1px]"
    (click)="closeAddCategoryModal()">
    <div class="flex w-full max-w-[620px] flex-col overflow-hidden rounded-lg bg-white shadow-xl"
      (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="flex items-center justify-between bg-[#E5E7EB] px-6 py-4">
        <h3 class="text-[13px] font-bold text-gray-900">
          {{ modalMode === 'edit' ? 'Update Category' : 'Create Category' }}
        </h3>
        <button type="button" (click)="closeAddCategoryModal()" class="text-gray-500 hover:text-gray-700">×</button>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto px-6 py-5">
        <div class="flex gap-6">
          <div class="flex-1 space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Category Name</label>
            <input [(ngModel)]="addForm.name" type="text" placeholder="Name"
              class="w-full rounded-sm border border-gray-300 bg-white px-3 py-2 text-[11px] outline-none" />
          </div>

          <div class="flex-1 space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Icon</label>
            <div class="relative flex h-[36px] items-center rounded-sm border border-gray-300 bg-white px-3">
              <span class="text-[10px] text-gray-400 truncate flex-1">{{ addForm.iconFileName || 'Choose icon' }}</span>
              <input #catIconInput type="file" accept="image/*" class="hidden"
                (change)="onCategoryIconPicked($event)" />
              <button type="button" (click)="catIconInput.click()"
                class="shrink-0 text-[#923D8C] text-[10px] font-bold">Browse</button>
            </div>
          </div>
        </div>

        <div class="mt-4 space-y-1">
          <label class="text-[11px] font-bold text-gray-700 ml-1">Description</label>
          <textarea [(ngModel)]="addForm.description" rows="3" placeholder="Description"
            class="w-full rounded-sm border border-gray-300 bg-white px-3 py-2 text-[11px] outline-none resize-none"></textarea>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-x-6 gap-y-4">
          <div class="space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Subcategories</label>
            <div class="flex gap-2">
              <input [(ngModel)]="addForm.subCategory" type="text" placeholder="Add"
                class="flex-1 rounded-sm border border-gray-300 bg-white px-3 py-2 text-[11px] outline-none" />
              <button type="button" (click)="addSubCategoryChip()"
                class="rounded-sm bg-[#923D8C] px-3 text-white text-[10px] font-bold">Add</button>
            </div>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let chip of addForm.subCategoryChips"
                class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ chip }}
                <button (click)="removeSubCategoryChip(chip)" class="text-gray-400 hover:text-red-500">×</button>
              </span>
            </div>
          </div>

          <div class="space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Creation Date</label>
            <input [(ngModel)]="addForm.creationDate" type="text" disabled
              class="w-full rounded-sm border border-gray-300 bg-gray-50 px-3 py-2 text-[11px] text-gray-500" />
          </div>

          <div class="space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Levels</label>
            <div class="flex gap-2">
              <input [(ngModel)]="addForm.level" type="text" placeholder="Add"
                class="flex-1 rounded-sm border border-gray-300 bg-white px-3 py-2 text-[11px] outline-none" />
              <button type="button" (click)="addLevelChip()"
                class="rounded-sm bg-[#923D8C] px-3 text-white text-[10px] font-bold">Add</button>
            </div>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let chip of addForm.levelChips"
                class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ chip }}
                <button (click)="removeLevelChip(chip)" class="text-gray-400 hover:text-red-500">×</button>
              </span>
            </div>
          </div>

          <div class="space-y-1">
            <label class="text-[11px] font-bold text-gray-700 ml-1">Age Groups</label>
            <div class="flex gap-2">
              <input [(ngModel)]="addForm.ageGroup" type="text" placeholder="Add"
                class="flex-1 rounded-sm border border-gray-300 bg-white px-3 py-2 text-[11px] outline-none" />
              <button type="button" (click)="addAgeGroupChip()"
                class="rounded-sm bg-[#923D8C] px-3 text-white text-[10px] font-bold">Add</button>
            </div>
            <div class="mt-2 flex flex-wrap gap-1.5">
              <span *ngFor="let chip of addForm.ageGroupChips"
                class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded bg-gray-100 text-gray-700 text-[10px] font-medium">
                {{ chip }}
                <button (click)="removeAgeGroupChip(chip)" class="text-gray-400 hover:text-red-500">×</button>
              </span>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <div class="flex items-center gap-6">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" value="Active" [(ngModel)]="addForm.visibility" class="h-3.5 w-3.5 text-[#923D8C]" />
              <span class="text-[11px] font-medium text-gray-700">Active</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" value="Inactive" [(ngModel)]="addForm.visibility"
                class="h-3.5 w-3.5 text-[#923D8C]" />
              <span class="text-[11px] font-medium text-gray-700">Inactive</span>
            </label>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-100 px-6 py-4 flex justify-end gap-3">
        <button (click)="closeAddCategoryModal()" [disabled]="isCreating"
          class="h-8 min-w-[90px] rounded-sm border border-gray-200 text-[11px] font-bold text-gray-600 hover:bg-gray-50 disabled:opacity-50">
          Cancel
        </button>
        <button (click)="createCategory()" [disabled]="!canCreateCategory || isCreating"
          class="h-8 min-w-[110px] rounded-sm bg-[#923D8C] text-white text-[11px] font-bold hover:bg-[#7a3270] disabled:opacity-50">
          <ng-container *ngIf="isCreating">{{ modalMode === 'edit' ? 'Updating...' : 'Creating...' }}</ng-container>
          <ng-container *ngIf="!isCreating">{{ modalMode === 'edit' ? 'Update Category' : 'Create Category'
            }}</ng-container>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- GLOBAL Status Modal -->
<app-status-modal [show]="showModal" [title]="modalTitle" [message]="modalMessage" [type]="modalType"
  (close)="closeModal()"></app-status-modal>