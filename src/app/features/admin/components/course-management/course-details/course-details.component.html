<!-- course-details.component.html -->
<div class="min-h-screen bg-[#F7F8FA] px-3 py-4 sm:px-4 sm:py-6 relative">
  <!-- Loading Overlay -->
  <div *ngIf="isLoading"
    class="absolute inset-0 z-[2000] flex items-center justify-center bg-white/60 backdrop-blur-[2px]">
    <div class="flex flex-col items-center gap-3">
      <div class="h-10 w-10 animate-spin rounded-full border-4 border-[#923D8C] border-t-transparent"></div>
      <p class="text-[13px] font-semibold text-gray-700">Loading course details...</p>
    </div>
  </div>

  <div class="mx-auto flex w-full max-w-[1200px] flex-col bg-[#FFFFFF9C] px-3 py-4 sm:px-4 sm:py-6 lg:px-6">
    <!-- ===================== HEADER ===================== -->
    <header class="flex flex-col gap-3 py-2 sm:py-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <!-- Left -->
        <div class="flex min-w-0 items-start gap-2">
          <button type="button" (click)="goBackToCourseManagement()"
            class="mt-[2px] inline-flex h-8 w-8 shrink-0 cursor-pointer items-center justify-center rounded-full bg-white text-gray-700 shadow-[0_1px_2px_rgba(0,0,0,0.06)] hover:bg-gray-100"
            aria-label="Back">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>

          <div class="min-w-0">
            <h1 class="truncate text-[16px] font-semibold text-gray-900 sm:text-[18px]">
              Course Details
            </h1>
            <p class="mt-0.5 text-[11px] text-gray-400 sm:text-xs">
              Edit and manage course information
            </p>
          </div>
        </div>

        <!-- Right buttons -->
        <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center sm:justify-end">


          <button type="button" (click)="onSaveDraft()"
            class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-sm border border-gray-200 bg-white px-4 text-xs font-semibold text-gray-700 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:bg-gray-50 sm:w-auto sm:px-3">
            <img src="/assets/admin/course-manage/save.svg" alt="save" class="h-4 w-4" />
            <span class="whitespace-nowrap">Save Draft</span>
          </button>

          <button type="button" (click)="onPublishCourse()"
            class="inline-flex h-9 w-full cursor-pointer items-center justify-center rounded-sm bg-[#923D8C] px-5 text-xs font-semibold text-white shadow-[0_1px_2px_rgba(0,0,0,0.08)] hover:bg-[#6B1A5D] sm:w-auto sm:px-4">
            <span class="whitespace-nowrap">Publish Course</span>
          </button>
        </div>
      </div>
    </header>

    <!-- ===================== COURSE COMPLETION (DYNAMIC / PIXEL PERFECT) ===================== -->
    <section
      class="w-full rounded-[8px] border border-[#E5E7EB] bg-white px-4 py-3 shadow-[0_1px_2px_rgba(0,0,0,0.06)] sm:px-5"
      aria-label="Course Completion">
      <!-- Top row -->
      <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-[12px] font-medium text-[#111827]">Course Completion</p>
        <p class="text-[12px] font-semibold text-[#8E3D86]">
          {{ overallCompletionPercent }}% Complete
        </p>
      </div>

      <!-- Progress bar -->
      <div class="mt-2 flex w-full items-center">
        <div class="h-[6px] w-full overflow-hidden rounded-full bg-[#E5E7EB]">
          <div class="h-[6px] rounded-full bg-[#8E3D86]" [style.width.%]="overallCompletionPercent"></div>
        </div>
      </div>

      <!-- Chips (DYNAMIC) -->
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <span *ngFor="let s of completionSteps; trackBy: trackByStepKey"
          class="inline-flex items-center gap-2 rounded-full px-3 py-[5px] text-[11px] font-medium sm:text-[12px]"
          [ngClass]="chipClass(s)">
          <ng-container [ngSwitch]="s.state">
            <span *ngSwitchCase="'complete'"
              class="flex h-4 w-4 items-center justify-center rounded-full border border-[#166534] text-[#166534]">
              <svg class="h-2.5 w-2.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M5 13l4 4L19 7" />
              </svg>
            </span>

            <span *ngSwitchCase="'current'"
              class="flex h-4 w-4 items-center justify-center rounded-full border border-[#7C1F6A] text-[#7C1F6A]">
              <span class="h-1.5 w-1.5 rounded-full bg-[#7C1F6A]"></span>
            </span>

            <svg *ngSwitchDefault xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
          </ng-container>

          <span class="whitespace-nowrap">{{ s.label }}</span>
        </span>
      </div>
    </section>
    <!-- ===================== /COURSE COMPLETION ===================== -->

    <!-- ===================== BASIC INFORMATION ===================== -->
    <section class="mt-4 overflow-hidden rounded-lg border border-gray-100 bg-white" aria-label="Basic Information">
      <div class="flex flex-col gap-2 bg-[#E5E7EB] px-4 py-3 sm:flex-row sm:items-center sm:justify-between sm:px-6">
        <div class="flex flex-wrap items-center gap-2">
          <h2 class="text-sm text-gray-800">{{ progress.sectionTitle }}</h2>

          <span *ngIf="progress.sectionStatus === 'incomplete'"
            class="inline-flex items-center rounded-full bg-[#FEE2E2] px-2 py-0.5 text-xs font-semibold text-[#B91C1C]">
            Incomplete
          </span>

          <span *ngIf="progress.sectionStatus === 'complete'"
            class="inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700">
            Complete
          </span>
        </div>

        <div class="flex flex-wrap items-center gap-4">
          <p class="text-[10px] font-medium text-gray-500 sm:text-[11px]">
            {{ progress.completedFields }}/{{ progress.totalFields }} fields completed
          </p>
        </div>
      </div>

      <div class="h-px bg-gray-100"></div>

      <div class="px-4 py-5 sm:px-6">
        <div class="flex flex-col gap-8 lg:flex-row lg:items-start">
          <!-- LEFT -->
          <div class="flex w-full flex-col gap-5 lg:w-1/2">
            <div>
              <label class="text-xs font-semibold text-gray-600">
                Add Title <span class="text-red-500">*</span>
              </label>
              <input type="text" [(ngModel)]="basicInfo.title" (ngModelChange)="onBasicChanged()" name="title"
                class="mt-1 h-9 w-full rounded-sm border border-gray-200 bg-white px-3 text-xs text-gray-700 placeholder:text-gray-400 focus:border-gray-300 focus:outline-none" />
            </div>

            <div>
              <div class="flex items-center gap-2">
                <label class="text-xs font-semibold text-gray-600">Course Thumbnail</label>
                <span *ngIf="isThumbnailComplete" class="text-xs text-emerald-500">✓</span>
              </div>

              <div class="mt-2 rounded-md border border-dashed border-gray-300 bg-white p-4">
                <div class="flex w-full flex-col items-center justify-center">
                  <img [src]="basicInfo.thumbnailUrl" alt="Course thumbnail"
                    class="h-[120px] w-full max-w-[260px] rounded-sm object-cover sm:max-w-[320px]" />

                  <input #thumbInput type="file" accept="image/*" class="hidden" (change)="onThumbnailPicked($event)" />

                  <button type="button" (click)="changeImage(thumbInput)"
                    class="mt-3 inline-flex h-8 w-full cursor-pointer items-center justify-center rounded-sm border border-gray-200 bg-white px-3 text-xs font-semibold text-gray-700 hover:bg-gray-50 sm:h-7 sm:w-auto">
                    Change Image
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="w-full lg:w-1/2">
            <div class="flex flex-col gap-4">
              <div>
                <label class="text-xs font-semibold text-gray-600">
                  Category <span class="text-red-500">*</span>
                </label>

                <div class="relative mt-1">
                  <select [(ngModel)]="basicInfo.category" (ngModelChange)="onBasicChanged()" name="category"
                    class="h-9 w-full appearance-none rounded-sm border border-gray-200 bg-white px-3 pr-9 text-xs text-gray-600 focus:border-gray-300 focus:outline-none">
                    <option value="" disabled>Select category</option>
                    <option *ngFor="let c of categories" [value]="c" [disabled]="c === 'Select category'">
                      {{ c }}
                    </option>
                  </select>

                  <svg class="pointer-events-none absolute right-3 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"
                    viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
              </div>

              <div>
                <label class="text-xs font-semibold text-gray-600">Select Sub Category</label>
                <div class="relative mt-1">
                  <select [(ngModel)]="basicInfo.subCategory" (ngModelChange)="onBasicChanged()" name="subCategory"
                    class="h-9 w-full appearance-none rounded-sm border border-gray-200 bg-white px-3 pr-9 text-xs text-gray-600 focus:border-gray-300 focus:outline-none">
                    <option value="" disabled>Select Sub Category</option>
                    <option *ngFor="let s of subCategories" [value]="s">
                      {{ s }}
                    </option>
                  </select>
                  <svg class="pointer-events-none absolute right-3 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
              </div>

              <div>
                <label class="text-xs font-semibold text-gray-600">Age Group</label>

                <div class="relative mt-1">
                  <select [(ngModel)]="basicInfo.ageGroup" (ngModelChange)="onBasicChanged()" name="ageGroup"
                    class="h-9 w-full appearance-none rounded-sm border border-gray-200 bg-white px-3 pr-9 text-xs text-gray-600 focus:border-gray-300 focus:outline-none">
                    <option value="" disabled>Select Age Group</option>
                    <option *ngFor="let a of ageGroups" [value]="a" [disabled]="a === 'Select Age Group'">
                      {{ a }}
                    </option>
                  </select>

                  <svg class="pointer-events-none absolute right-3 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"
                    viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
              </div>

              <div>
                <label class="text-xs font-semibold text-gray-600">
                  Enrollment Type <span class="text-red-500">*</span>
                </label>
                <div class="relative mt-1">
                  <select [(ngModel)]="basicInfo.courseEnrollementType" (ngModelChange)="onBasicChanged()"
                    name="courseEnrollementType"
                    class="h-9 w-full appearance-none rounded-sm border border-gray-200 bg-white px-3 pr-9 text-xs text-gray-600 focus:border-gray-300 focus:outline-none">
                    <option value="live">Live</option>
                    <option value="recorded">Recorded</option>
                  </select>
                  <svg class="pointer-events-none absolute right-3 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
              </div>

              <div>
                <label class="text-xs font-semibold text-gray-600">Course Access</label>
                <input type="text" [(ngModel)]="basicInfo.courseAccess" (ngModelChange)="onBasicChanged()"
                  name="courseAccess" placeholder="e.g. Free, Premium, Specific Role"
                  class="mt-1 h-9 w-full rounded-sm border border-gray-200 bg-white px-3 text-xs text-gray-700 placeholder:text-gray-400 focus:border-gray-300 focus:outline-none" />
              </div>

              <div>
                <label class="text-xs font-semibold text-gray-600">
                  Price <span class="text-red-500">*</span>
                </label>

                <div class="mt-1 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
                  <div class="relative w-full">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-gray-400">$</span>
                    <input type="number" [(ngModel)]="basicInfo.price" (ngModelChange)="onBasicChanged()" name="price"
                      class="h-9 w-full rounded-sm border border-gray-200 bg-white pl-6 pr-3 text-xs text-gray-700 focus:border-gray-300 focus:outline-none"
                      step="0.01" />
                  </div>

                  <div class="relative w-full sm:w-[110px]">
                    <select [(ngModel)]="basicInfo.currency" (ngModelChange)="onBasicChanged()" name="currency"
                      class="h-9 w-full appearance-none rounded-sm border border-gray-200 bg-white px-3 pr-7 text-xs text-gray-600 focus:border-gray-300 focus:outline-none">
                      <option *ngFor="let cur of currencies" [value]="cur">{{ cur }}</option>
                    </select>

                    <svg class="pointer-events-none absolute right-2 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"
                      viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /RIGHT -->
        </div>
      </div>
    </section>

    <!-- ===================== COURSE OVERVIEW ===================== -->
    <section class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white" aria-label="Course Overview">
      <div class="flex flex-col gap-2 bg-[#E5E7EB] px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap items-center gap-2">
          <h2 class="text-sm text-gray-900">Course Overview</h2>
          <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold"
            [ngClass]="courseOverview.status === 'complete' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'">
            {{ courseOverview.status === "complete" ? "Complete" : "Incomplete" }}
          </span>
        </div>

        <div class="flex flex-wrap items-center gap-4">
          <div class="text-[10px] font-medium text-gray-500 sm:text-[11px]">
            {{ courseOverview.completedFields }}/{{ courseOverview.totalFields }} fields completed
          </div>
        </div>
      </div>

      <div class="h-px bg-gray-200"></div>

      <div class="px-4 py-4">
        <div>
          <label class="flex items-center gap-1 text-xs font-semibold text-gray-600">
            <span>Course Description</span>
            <span *ngIf="isCourseOverviewFieldComplete('description')" class="text-emerald-600">✓</span>
          </label>

          <textarea [(ngModel)]="courseOverview.description" (ngModelChange)="onOverviewChanged()"
            name="courseDescription" rows="4"
            class="mt-2 w-full resize-none rounded-md border border-gray-200 bg-white px-3 py-2 text-xs leading-4 text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none"></textarea>
        </div>

        <div class="mt-4 flex flex-col gap-4 sm:flex-row">
          <div class="w-full sm:w-1/2">
            <label class="flex items-center gap-1 text-xs font-semibold text-gray-600">
              <span>Duration</span>
              <span *ngIf="isCourseOverviewFieldComplete('duration')" class="text-emerald-600">✓</span>
            </label>

            <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:items-center">
              <input [(ngModel)]="courseOverview.duration" (ngModelChange)="onOverviewChanged()" name="duration"
                type="number"
                class="h-9 w-full rounded-md border border-gray-200 bg-white px-3 text-xs text-gray-700 focus:border-gray-300 focus:outline-none" />

              <select [(ngModel)]="courseOverview.durationUnit" (ngModelChange)="onOverviewChanged()"
                name="durationUnit"
                class="h-9 w-full rounded-md border border-gray-200 bg-white px-2 text-xs text-gray-700 focus:border-gray-300 focus:outline-none sm:w-32">
                <option *ngFor="let u of durationUnits" [ngValue]="u">{{ u }}</option>
              </select>
            </div>
          </div>

          <div class="w-full sm:w-1/2">
            <label class="flex items-center gap-1 text-xs font-semibold text-gray-600">
              <span>Level</span>
              <span *ngIf="isCourseOverviewFieldComplete('level')" class="text-emerald-600">✓</span>
            </label>

            <div class="relative mt-2">
              <select [(ngModel)]="courseOverview.level" (ngModelChange)="onOverviewChanged()" name="level"
                class="h-9 w-full appearance-none rounded-md border border-gray-200 bg-white px-3 pr-8 text-xs text-gray-700 focus:border-gray-300 focus:outline-none">
                <option value="" disabled>Select Level</option>
                <option *ngFor="let l of levels" [value]="l">{{ l }}</option>
              </select>

              <svg class="pointer-events-none absolute right-2 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"
                viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-col gap-4 sm:flex-row">
          <div class="w-full sm:w-1/2">
            <label class="flex items-center gap-1 text-xs font-semibold text-gray-600">
              <span>Prerequisites</span>
              <span *ngIf="isCourseOverviewFieldComplete('prerequisites')" class="text-emerald-600">✓</span>
            </label>

            <input [(ngModel)]="courseOverview.prerequisites" (ngModelChange)="onOverviewChanged()" name="prerequisites"
              type="text"
              class="mt-2 h-9 w-full rounded-md border border-gray-200 bg-white px-3 text-xs text-gray-700 focus:border-gray-300 focus:outline-none" />
          </div>

          <div class="w-full sm:w-1/2">
            <label class="flex items-center gap-1 text-xs font-semibold text-gray-600">
              <span>Target Audience</span>
              <span *ngIf="isCourseOverviewFieldComplete('targetAudience')" class="text-emerald-600">✓</span>
            </label>

            <input [(ngModel)]="courseOverview.targetAudience" (ngModelChange)="onOverviewChanged()"
              name="targetAudience" type="text"
              class="mt-2 h-9 w-full rounded-md border border-gray-200 bg-white px-3 text-xs text-gray-700 focus:border-gray-300 focus:outline-none" />
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== LEARNING OUTCOMES ===================== -->
    <section class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white" aria-label="Learning Outcomes">
      <div class="flex flex-col gap-2 bg-[#E5E7EB] px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap items-center gap-2">
          <h2 class="text-sm text-gray-900">Learning Outcomes</h2>

          <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold"
            [ngClass]="learningOutcomes.status === 'complete' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'">
            {{ learningOutcomes.status === "complete" ? "Complete" : "Incomplete" }}
          </span>
        </div>

        <div class="text-[10px] font-medium text-gray-500">
          {{ learningOutcomes.completedFields }}/{{ learningOutcomes.totalFields }} fields completed
        </div>
      </div>

      <div class="h-px bg-gray-200"></div>

      <div class="px-4 py-4">
        <div class="text-xs font-semibold text-gray-700">
          What You'll Learn
          <span class="font-normal text-gray-400">(Minimum {{ learningOutcomes.minOutcomes }} outcomes required)</span>
        </div>

        <div class="mt-3 flex flex-col gap-2">
          <div *ngFor="let item of learningOutcomes.items; let i = index; trackBy: trackById" class="relative">
            <input [(ngModel)]="item.description" (ngModelChange)="onOutcomesChanged()"
              [ngModelOptions]="{ standalone: true }" type="text"
              class="h-10 w-full rounded-md border border-gray-200 bg-white pl-3 pr-10 text-xs text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none"
              placeholder="Write a learning outcome..." />

            <button type="button" (click)="removeOutcome(i)"
              class="absolute right-2 top-1/2 inline-flex h-8 w-8 -translate-y-1/2 cursor-pointer items-center justify-center rounded-md hover:bg-gray-50"
              aria-label="Delete outcome">
              <img src="/assets/admin/course-manage/deleteicon.svg" alt="Delete Icon" class="h-4 w-4" />
            </button>
          </div>

          <div class="mt-2 flex flex-wrap items-center gap-3">
            <button type="button" (click)="addOutcome()" [disabled]="isAddingOutcome"
              class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-md border border-gray-200 bg-white px-3 text-xs font-medium text-gray-700 hover:bg-gray-50 sm:w-fit sm:justify-start disabled:opacity-50 disabled:cursor-not-allowed">
              <span *ngIf="isAddingOutcome"
                class="h-3 w-3 animate-spin rounded-full border-2 border-gray-500 border-t-transparent"></span>
              <span *ngIf="!isAddingOutcome" class="text-sm leading-none text-gray-500">+</span>
              {{ isAddingOutcome ? 'Adding...' : 'Add Outcome' }}
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========================= COURSE MODULES ========================= -->
    <section class="mt-4 overflow-hidden rounded-md border border-gray-200 bg-white" aria-label="Course Modules">
      <div class="flex flex-col gap-2 bg-[#F9FAFB] px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap items-center gap-2">
          <h2 class="text-sm text-gray-800">Course Modules</h2>

          <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[9px] font-semibold" [ngClass]="
              courseModules.status === 'complete'
                ? 'bg-emerald-50 text-emerald-700'
                : courseModules.status === 'partial'
                ? 'bg-yellow-50 text-yellow-700'
                : 'bg-red-50 text-red-700'
            ">
            {{
            courseModules.status === "complete"
            ? "Complete"
            : courseModules.status === "partial"
            ? "Partially Complete"
            : "Incomplete"
            }}
          </span>
        </div>

        <div class="text-[10px] font-medium text-gray-500 sm:text-[11px]">
          {{ courseModules.completedModules }}/{{ courseModules.totalModules }} modules completed
        </div>
      </div>

      <div class="h-px bg-gray-200"></div>

      <div class="px-4 py-4">
        <div class="flex flex-col gap-3">
          <article *ngFor="let m of courseModules.items; let i = index; trackBy: trackByModuleId"
            class="overflow-hidden rounded-md border border-gray-200 bg-white">
            <div class="flex flex-col gap-2 bg-[#F9FAFB] px-3 py-2 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex min-w-0 flex-wrap items-center gap-2">
                <span
                  class="inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-[#7C1F6A] text-[10px] font-semibold text-white">
                  {{ i + 1 }}
                </span>

                <div class="min-w-0">
                  <div *ngIf="!m.isNew; else moduleTitleEdit" class="truncate text-[11px] font-semibold text-gray-900">
                    {{ m.title || "Untitled Module" }}
                  </div>

                  <ng-template #moduleTitleEdit>
                    <input [ngModel]="m.title" (ngModelChange)="onModuleFieldChange(i, 'title', $event)"
                      [ngModelOptions]="{ standalone: true }" type="text" placeholder="Module name"
                      class="h-9 w-full rounded-md border border-gray-200 bg-white px-3 text-[11px] text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none sm:w-[260px]" />
                  </ng-template>
                </div>

                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[9px] font-semibold"
                  [ngClass]="m.status === 'complete' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'">
                  {{ m.status === "complete" ? "Complete" : "Incomplete" }}
                </span>

                <span *ngIf="(m.draftMaterials?.length || 0) > 0"
                  class="inline-flex items-center rounded-full bg-[#DBEAFE] px-2 py-0.5 text-[9px] font-semibold text-[#1D4ED8]">
                  {{ m.draftMaterials.length }} pending
                </span>
              </div>

              <div class="flex items-center justify-end gap-2">
                <button type="button" (click)="toggleModule(m)"
                  class="inline-flex h-8 w-8 cursor-pointer items-center justify-center rounded-sm hover:bg-white"
                  aria-label="Toggle module">
                  <svg class="h-4 w-4 text-gray-400 transition" [ngClass]="m.expanded ? 'rotate-180' : 'rotate-0'"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </button>

                <button type="button" (click)="deleteModule(i)"
                  class="inline-flex h-8 w-8 cursor-pointer items-center justify-center rounded-sm hover:bg-white"
                  aria-label="Delete module">
                  <img src="/assets/admin/course-manage/deleteicon.svg" alt="Delete" class="h-4 w-4 opacity-70" />
                </button>
              </div>
            </div>

            <div *ngIf="m.expanded" class="px-3 py-3">
              <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:gap-4">
                <div class="flex w-full flex-col lg:flex-1">
                  <label class="text-[10px] font-medium text-gray-600">
                    Module Description <span class="text-red-500">*</span>
                  </label>

                  <textarea [ngModel]="m.description" (ngModelChange)="onModuleFieldChange(i, 'description', $event)"
                    [ngModelOptions]="{ standalone: true }" rows="3" placeholder="Enter module description"
                    class="mt-2 w-full resize-none rounded-md border border-gray-200 bg-white px-3 py-2 text-[10px] leading-4 text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none"></textarea>
                </div>

                <div class="flex w-full flex-col gap-3 lg:w-[520px]">
                  <div class="flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:items-end">
                    <div class="flex w-full flex-col sm:w-[180px]">
                      <label class="text-[10px] font-medium text-gray-600">
                        Number of Sessions <span class="text-red-500">*</span>
                      </label>
                      <input [ngModel]="m.sessions" (ngModelChange)="onModuleFieldChange(i, 'sessions', $event)"
                        [ngModelOptions]="{ standalone: true }" type="number" placeholder="Enter number of sessions"
                        class="mt-2 h-10 w-full rounded-md border border-gray-200 bg-white px-3 text-[10px] text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none" />
                    </div>

                    <div class="flex w-full flex-col sm:w-[240px]">
                      <label class="text-[10px] font-medium text-gray-600">
                        Session Duration <span class="text-red-500">*</span>
                      </label>

                      <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:items-center">
                        <input [ngModel]="m.durationMinutes"
                          (ngModelChange)="onModuleFieldChange(i, 'durationMinutes', $event)"
                          [ngModelOptions]="{ standalone: true }" type="number" placeholder="Enter duration in minutes"
                          class="h-10 w-full rounded-md border border-gray-200 bg-white px-3 text-[10px] text-gray-700 placeholder:text-gray-300 focus:border-gray-300 focus:outline-none" />

                        <div
                          class="flex h-10 w-full items-center justify-center rounded-md border border-gray-200 bg-white px-3 text-[10px] text-gray-600 sm:w-auto">
                          minutes
                        </div>
                      </div>
                    </div>

                    <button type="button" (click)="openUploadMaterialModal(i)"
                      class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-md border border-gray-200 bg-white px-4 text-[10px] font-medium text-gray-700 hover:bg-gray-50 sm:w-[160px]">
                      <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      </svg>
                      Add Material
                    </button>

                    <button type="button" (click)="saveModule(i)" [disabled]="isModuleSaving(m.id) || !canSaveModule(m)"
                      class="inline-flex h-10 w-full items-center justify-center rounded-md px-6 text-[10px] font-semibold text-white sm:w-[120px]"
                      [ngClass]="
                        isModuleSaving(m.id) || !canSaveModule(m)
                          ? 'bg-gray-600 cursor-not-allowed'
                          : 'bg-gray-500 hover:opacity-95 cursor-pointer'
                      ">
                      {{ isModuleSaving(m.id) ? "Saving..." : "Save" }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </article>

          <button type="button" (click)="addModule()"
            class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-md border border-gray-200 bg-white px-4 text-[11px] font-medium text-gray-700 hover:bg-gray-50 sm:w-fit sm:justify-start">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            Add Module
          </button>
        </div>
      </div>
    </section>


    <!-- =========================  UPLOAD MODAL (API-BASED) ========================= -->
    <div *ngIf="showUploadModal"
      class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/40 px-3 sm:px-4" role="dialog"
      aria-modal="true">
      <div class="w-full max-w-[980px] overflow-hidden rounded-sm bg-white shadow-[0_18px_45px_rgba(0,0,0,0.25)]">
        <div class="flex items-center justify-between border-b border-gray-200 px-4 py-4 sm:px-6">
          <div class="text-[16px] font-semibold text-gray-900 sm:text-lg">Upload Course Material</div>

          <button type="button" (click)="closeUploadMaterialModal()"
            class="inline-flex h-9 w-9 cursor-pointer items-center justify-center rounded-sm text-gray-500 hover:bg-gray-50"
            aria-label="Close">
            ✕
          </button>
        </div>

        <div class="px-4 py-5 sm:px-6">
          <!-- Title Field -->
          <div class="mb-4">
            <label class="text-xs font-semibold text-gray-700">
              Material Title <span class="text-red-500">*</span>
            </label>
            <input type="text" [(ngModel)]="uploadTitle" placeholder="Enter material title..." [disabled]="isUploading"
              class="mt-2 h-10 w-full rounded-md border border-gray-200 bg-white px-3 text-xs text-gray-700 placeholder:text-gray-400 focus:border-gray-300 focus:outline-none disabled:bg-gray-50 disabled:cursor-not-allowed" />
          </div>

          <div class="relative rounded-sm border border-dashed border-gray-300 bg-white px-4 py-8 sm:px-6 sm:py-10"
            (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
            [ngClass]="dragOver ? 'bg-gray-50' : ''">
            <input #multiPicker type="file" class="hidden" [attr.accept]="acceptForPicker" multiple
              (change)="onBrowsePicked($event)" [disabled]="isUploading" />

            <div *ngIf="selectedFiles.length > 0; else emptyUploadState" class="flex flex-col gap-3">
              <div *ngFor="let f of selectedFiles; let fi = index"
                class="flex flex-col gap-2 rounded-sm bg-gray-100 px-3 py-2 sm:flex-row sm:items-start sm:gap-3">
                <div class="mt-0.5 flex h-7 w-7 shrink-0 items-center justify-center rounded-sm bg-white">
                  <img [src]="getUploadRowIcon(f)" alt="type" class="h-4 w-4" />
                </div>

                <div class="min-w-0 flex-1">
                  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between sm:gap-3">
                    <div class="truncate text-xs text-gray-700">
                      {{ f.name }} ({{ formatBytes(f.size) }})
                    </div>
                    <button type="button" *ngIf="!isUploading"
                      class="w-fit cursor-pointer text-[11px] text-blue-600 hover:underline"
                      (click)="renameSelectedFile(fi)">
                      Rename
                    </button>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mt-2 h-1.5 w-full rounded-full bg-gray-200">
                    <div class="h-1.5 rounded-full transition-all duration-300"
                      [ngClass]="fileUploadProgress[fi] === 100 ? 'bg-emerald-500' : 'bg-blue-500'"
                      [style.width.%]="fileUploadProgress[fi] || 0"></div>
                  </div>

                  <!-- Progress Percentage -->
                  <div *ngIf="isUploading && fileUploadProgress[fi] !== undefined"
                    class="mt-1 text-[10px] text-gray-500">
                    {{ fileUploadProgress[fi] }}%
                  </div>
                </div>

                <button type="button" *ngIf="!isUploading"
                  class="inline-flex h-8 w-8 cursor-pointer items-center justify-center rounded-sm text-gray-600 hover:bg-white sm:mt-0.5 sm:h-7 sm:w-7"
                  aria-label="Remove" (click)="removeSelectedFile(fi)">
                  ✕
                </button>
              </div>

              <div class="pt-1" *ngIf="!isUploading">
                <button type="button" (click)="onAttachClick(multiPicker)"
                  class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#7C1F6A] px-4 text-xs font-semibold text-white hover:opacity-95 sm:w-fit sm:justify-start">
                  <span class="text-sm leading-none">✎</span>
                  Attach More Files
                </button>

                <div *ngIf="showAttachOptions && !attachPickKind" class="mt-3 flex items-center gap-3">
                  <button type="button" (click)="pickAttachKind('video', multiPicker)"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-sm border border-gray-200 bg-white hover:bg-gray-50"
                    aria-label="Pick Video">
                    <img src="/assets/admin/course-manage/video.svg" alt="Video" class="h-5 w-5" />
                  </button>

                  <button type="button" (click)="pickAttachKind('doc', multiPicker)"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-sm border border-gray-200 bg-white hover:bg-gray-50"
                    aria-label="Pick Doc">
                    <img src="/assets/admin/course-manage/pdf.svg" alt="Doc" class="h-5 w-5" />
                  </button>
                </div>
              </div>
            </div>

            <ng-template #emptyUploadState>
              <div class="flex flex-col items-center justify-center gap-3">
                <button type="button" (click)="onAttachClick(multiPicker)"
                  class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#7C1F6A] px-4 text-xs font-semibold text-white hover:opacity-95 sm:w-fit">
                  <span class="text-sm leading-none">✎</span>
                  Attach File
                </button>

                <div *ngIf="showAttachOptions && !attachPickKind" class="flex items-center gap-3">
                  <button type="button" (click)="pickAttachKind('video', multiPicker)"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-sm border border-gray-200 bg-white hover:bg-gray-50"
                    aria-label="Pick Video">
                    <img src="/assets/admin/course-manage/video.svg" alt="Video" class="h-5 w-5" />
                  </button>

                  <button type="button" (click)="pickAttachKind('doc', multiPicker)"
                    class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-sm border border-gray-200 bg-white hover:bg-gray-50"
                    aria-label="Pick Doc">
                    <img src="/assets/admin/course-manage/pdf.svg" alt="Doc" class="h-5 w-5" />
                  </button>
                </div>
              </div>
            </ng-template>
          </div>

          <div class="mt-3 text-[11px] text-gray-500">
            Supported Formats: Video (MP4, AVI, MOV), PDF, DOC, PPT
          </div>

          <div *ngIf="uploadError" class="mt-2 text-xs font-medium text-red-600">
            {{ uploadError }}
          </div>

          <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end sm:gap-3">
            <button type="button" (click)="closeUploadMaterialModal()" [disabled]="isUploading"
              class="inline-flex h-10 w-full cursor-pointer items-center justify-center rounded-sm border border-gray-300 bg-white px-6 text-xs font-medium text-gray-700 hover:bg-gray-50 sm:w-auto disabled:cursor-not-allowed disabled:opacity-50">
              {{ isUploading ? 'Uploading...' : 'Cancel' }}
            </button>

            <button type="button" (click)="confirmUploadWithApi()" [disabled]="isUploading || !selectedFiles.length"
              class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#7C1F6A] px-6 text-xs font-semibold text-white hover:opacity-95 sm:w-auto disabled:cursor-not-allowed disabled:opacity-50">
              <span class="text-xs">⭳</span>
              {{ isUploading ? 'Uploading...' : 'Upload' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== COURSE MATERIALS (READS FROM MODULES) ===================== -->
    <section class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white" aria-label="Course Materials">
      <div class="flex flex-col gap-2 bg-[#E5E7EB] px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex flex-wrap items-center gap-2">
          <h2 class="text-xs font-semibold text-gray-900">Course Materials</h2>

          <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold" [ngClass]="
              courseMaterialsStatus === 'complete'
                ? 'bg-emerald-50 text-emerald-700'
                : courseMaterialsStatus === 'partial'
                ? 'bg-yellow-50 text-yellow-700'
                : 'bg-red-50 text-red-700'
            ">
            {{
            courseMaterialsStatus === "complete"
            ? "Complete"
            : courseMaterialsStatus === "partial"
            ? "Partially Complete"
            : "Incomplete"
            }}
          </span>
        </div>

        <div class="text-[10px] font-medium text-gray-500">
          {{ uploadedFilesCount }}/{{ totalFilesCount }} files uploaded
        </div>
      </div>

      <div class="h-px bg-gray-200"></div>

      <div class="px-4 pt-3 pb-4">
        <div class="flex flex-wrap items-center gap-6 border-b border-gray-200">
          <button type="button" (click)="materialsTab = 'recorded'"
            class="relative cursor-pointer pb-2 text-[10px] font-medium"
            [ngClass]="materialsTab === 'recorded' ? 'text-[#7C1F6A]' : 'text-gray-500 hover:text-gray-700'">
            Recorded Lectures
            <span *ngIf="materialsTab === 'recorded'"
              class="absolute left-0 -bottom-px h-0.5 w-full bg-[#7C1F6A]"></span>
          </button>

          <button type="button" (click)="materialsTab = 'pdf'"
            class="relative cursor-pointer pb-2 text-[10px] font-medium"
            [ngClass]="materialsTab === 'pdf' ? 'text-[#7C1F6A]' : 'text-gray-500 hover:text-gray-700'">
            PDF Materials
            <span *ngIf="materialsTab === 'pdf'" class="absolute left-0 -bottom-px h-0.5 w-full bg-[#7C1F6A]"></span>
          </button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="text-[10px] font-semibold text-gray-700">
            {{ materialsTab === "recorded" ? "Recorded Lectures" : "Notes" }}
          </div>
          <div class="text-[10px] font-medium text-gray-400">
            {{ currentTabUploadedCount }}/{{ currentTabTotalCount }} uploaded
          </div>
        </div>

        <div class="mt-3 overflow-hidden rounded-lg border border-gray-200">
          <!-- Recorded -->
          <ng-container *ngIf="materialsTab === 'recorded'">
            <div *ngFor="let m of recordedModules; let i = index; trackBy: trackByMaterialsModuleId"
              class="flex flex-col gap-3 bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex min-w-0 items-center gap-3">
                <div class="flex h-9 w-9 items-center justify-center rounded-full"
                  [ngClass]="m.files.length ? 'bg-[#7C1F6A]/10' : 'bg-gray-100'">
                  <ng-container *ngIf="m.files.length; else recEmpty">
                    <img src="/assets/admin/course-manage/video.svg" alt="" class="h-4 w-4 object-contain" />
                  </ng-container>
                  <ng-template #recEmpty>
                    <div class="h-3.5 w-3.5 rounded-sm bg-gray-300"></div>
                  </ng-template>
                </div>

                <div class="min-w-0">
                  <div class="truncate text-[11px] font-semibold text-gray-900 sm:text-[10px]">{{ m.title }}</div>
                  <div class="mt-0.5 truncate text-[10px] text-gray-400 sm:text-[9px]">
                    {{
                    m.files.length
                    ? m.files.length + " Files - " + formatBytes(sumSize(m.files))
                    : "Not uploaded"
                    }}
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-end gap-3">
                <button type="button" (click)="openMaterialsModal('recorded', i)" class="cursor-pointer p-1"
                  aria-label="View">
                  <svg class="h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" />
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" stroke-width="2" />
                  </svg>
                </button>
              </div>
            </div>
          </ng-container>

          <!-- PDF -->
          <ng-container *ngIf="materialsTab === 'pdf'">
            <div *ngFor="let m of pdfModules; let i = index; trackBy: trackByMaterialsModuleId"
              class="flex flex-col gap-3 bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex min-w-0 items-center gap-3">
                <div class="flex h-9 w-9 items-center justify-center rounded-full"
                  [ngClass]="m.files.length ? 'bg-[#7C1F6A]/10' : 'bg-gray-100'">
                  <ng-container *ngIf="m.files.length; else pdfEmpty">
                    <img src="/assets/admin/course-manage/pdf.svg" alt="" class="h-4 w-4 object-contain" />
                  </ng-container>
                  <ng-template #pdfEmpty>
                    <div class="h-3.5 w-3.5 rounded-sm bg-gray-300"></div>
                  </ng-template>
                </div>

                <div class="min-w-0">
                  <div class="truncate text-[11px] font-semibold text-gray-900 sm:text-[10px]">{{ m.title }}</div>
                  <div class="mt-0.5 truncate text-[10px] text-gray-400 sm:text-[9px]">
                    {{
                    m.files.length
                    ? m.files.length + " Files - " + formatBytes(sumSize(m.files))
                    : "Not uploaded"
                    }}
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-end gap-3">
                <button type="button" (click)="openMaterialsModal('pdf', i)" class="cursor-pointer p-1"
                  aria-label="View">
                  <svg class="h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" />
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" stroke-width="2" />
                  </svg>
                </button>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </section>

    <!-- ========================= Materials Modal ========================= -->

    <!-- ========================= Materials Modal ========================= -->
    <div *ngIf="showMaterialsModal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 px-3">
      <div class="w-full max-w-[980px] overflow-hidden rounded-lg bg-white shadow-[0_20px_60px_rgba(0,0,0,0.25)]">
        <div class="flex flex-col gap-3 px-4 pt-5 pb-3 sm:flex-row sm:items-center sm:justify-between sm:px-6">
          <div class="flex flex-wrap items-center gap-3">
            <div class="text-[18px] font-semibold text-[#111827] sm:text-xl">
              {{ materialsModalTitle }}
            </div>

            <span
              class="inline-flex items-center rounded-full bg-[#F3D7F0] px-4 py-1 text-xs font-medium text-[#7C1F6A]">
              {{ materialsModalKind === "recorded" ? "Rec Lectures" : "Pdf Materials" }}
            </span>
          </div>

          <button type="button" (click)="closeMaterialsModal(false)"
            class="inline-flex h-9 w-9 cursor-pointer items-center justify-center rounded-full text-[#111827] hover:bg-[#F3F4F6]"
            aria-label="Close">
            ✕
          </button>
        </div>

        <div class="px-4 pb-5 sm:px-6">
          <div class="rounded-sm border border-dashed border-[#D1D5DB] p-4">
            <!-- Files List or Empty State -->
            <div *ngIf="materialsWorkingFiles.length > 0; else emptyMaterialsState" class="flex flex-col gap-3">
              <div *ngFor="let f of materialsWorkingFiles; let idx = index; trackBy: trackByMaterialFileId"
                class="flex flex-col gap-3 bg-[#EEEEEE] px-4 py-3 sm:flex-row sm:items-center sm:justify-between sm:py-2">
                <div class="flex min-w-0 items-center gap-3">
                  <div
                    class="flex h-8 w-8 shrink-0 items-center justify-center rounded-sm bg-white text-xs font-medium text-[#111827]">
                    {{ idx + 1 }}
                  </div>

                  <img
                    [src]="materialsModalKind === 'recorded' ? '/assets/admin/course-manage/video.svg' : '/assets/admin/course-manage/pdf.svg'"
                    alt="" class="h-4 w-4 shrink-0" />

                  <div class="min-w-0">
                    <div class="truncate text-xs text-[#111827]">
                      {{ f.name }}
                      <span class="text-[#6B7280]">({{ formatBytes(f.size) }})</span>
                    </div>

                    <button type="button" (click)="renameMaterialFile(idx)"
                      class="mt-1 cursor-pointer text-left text-[11px] font-medium text-[#2563EB] hover:underline">
                      Rename
                    </button>
                  </div>
                </div>

                <div class="flex items-center justify-end gap-4">
                  <button type="button" (click)="downloadMaterialFile(idx)" class="cursor-pointer p-1"
                    aria-label="Download">
                    <svg class="h-4 w-4 text-[#6B7280]" viewBox="0 0 24 24" fill="none">
                      <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                      <path d="M5 21h14" stroke="currentColor" stroke-linecap="round" />
                    </svg>
                  </button>

                  <button type="button" (click)="removeMaterialFile(idx)" class="cursor-pointer p-1"
                    aria-label="Delete">
                    <img src="/assets/admin/course-manage/deleteicon.svg" class="h-4 w-4 opacity-80" alt="Delete" />
                  </button>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <ng-template #emptyMaterialsState>
              <div class="py-8 text-center">
                <p class="text-sm text-gray-500">No materials uploaded yet</p>
              </div>
            </ng-template>
          </div>
        </div>

      </div>
    </div>

    <!-- ===================== INSTRUCTORS (Assigned + Available) ===================== -->
    <section class="mt-4 w-full rounded-md bg-white px-4 py-4 sm:px-6" aria-label="Instructors">
      <!-- Assigned -->
      <div class="flex flex-col gap-3">
        <div class="text-xs font-semibold text-[#111827]">
          Currently Assigned Instructors ({{ assignedCount }})
        </div>

        <div class="flex flex-col gap-2">
          <div *ngFor="let ins of assignedInstructors"
            class="flex w-full flex-col gap-3 rounded-md border border-[#D1FAE5] bg-[#F0FDF4] px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
            <!-- LEFT -->
            <div class="flex min-w-0 items-start gap-3 sm:items-center">
              <div
                class="flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-full border border-[#E5E7EB] bg-white">
                <ng-container *ngIf="ins.avatarUrl; else aFallback">
                  <img [src]="ins.avatarUrl" alt="" class="h-10 w-10 object-cover" />
                </ng-container>
                <ng-template #aFallback>
                  <div class="text-[11px] font-semibold text-gray-600">
                    {{ avatarFallback(ins.name) }}
                  </div>
                </ng-template>
              </div>

              <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <div class="truncate text-xs font-semibold text-[#111827]">{{ ins.name }}</div>

                  <span
                    class="inline-flex items-center gap-1 rounded-full bg-[#DCFCE7] px-2 py-0.5 text-[10px] font-semibold text-[#15803D]">
                    <span class="text-[10px] leading-none">✓</span>
                    Assigned
                  </span>
                </div>

                <div class="mt-0.5 truncate text-[10px] text-[#6B7280]">{{ ins.email }}</div>

                <div class="mt-0.5 flex flex-wrap items-center gap-x-3 gap-y-1 text-[10px] text-[#6B7280]">
                  <span class="truncate">Specialization: {{ ins.specialization }}</span>
                </div>

                <div class="mt-0.5 flex flex-wrap items-center gap-x-3 gap-y-1 text-[10px] text-[#6B7280]">
                  <span>Assigned: {{ ins.assignedDateText }}</span>
                </div>
              </div>
            </div>

            <!-- RIGHT -->
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end sm:gap-3">
              <div class="flex items-center justify-between sm:flex-col sm:items-end sm:leading-tight">
                <!-- Removed Rating and Students as requested -->
              </div>

              <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <button type="button" (click)="openInstructorProfile(ins)"
                  class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-1 rounded-full bg-[#EF4444] px-4 text-[11px] font-semibold text-white hover:opacity-95 sm:h-7 sm:w-auto sm:text-[10px]">
                  <svg class="h-3.5 w-2.5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M5 12h14" />
                  </svg>
                  Remove
                </button>

                <button type="button"
                  class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-full bg-[#374151] px-4 text-[11px] font-semibold text-white hover:opacity-95 sm:h-7 sm:w-auto sm:text-[10px]">
                  <svg class="h-3.5 w-3.5 text-white/90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" />
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" stroke-width="2" />
                  </svg>
                  View Profile
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Available -->
      <div class="mt-5 flex flex-col gap-3">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div class="text-xs font-semibold text-[#111827]">
            Available Instructors ({{ availableCount }})
          </div>

          <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center">
            <button type="button" (click)="showInstructorFilters = !showInstructorFilters"
              class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-sm border border-[#E5E7EB] bg-white px-3 text-[11px] font-semibold text-[#374151] hover:bg-[#F9FAFB] sm:h-7 sm:w-auto sm:text-[10px]">
              <svg class="h-3.5 w-3.5 text-[#6B7280]" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 5h16M7 12h10M10 19h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              Filter
            </button>

            <div class="flex h-9 w-full items-center rounded-sm border border-[#E5E7EB] bg-white px-2 sm:h-7 sm:w-auto">
              <svg class="h-3.5 w-3.5 text-[#6B7280]" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 10l5-5 5 5M17 14l-5 5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>

              <select [(ngModel)]="instructorSort"
                class="h-8 w-full cursor-pointer bg-transparent pl-2 text-[11px] font-semibold text-[#374151] focus:outline-none sm:h-6 sm:w-[170px] sm:text-[10px]">
                <option value="rating_desc">Sort by Rating</option>
                <option value="rating_asc">Rating (Low to High)</option>
              </select>
            </div>
          </div>
        </div>

        <div *ngIf="showInstructorFilters" class="rounded-md border border-[#E5E7EB] bg-[#F9FAFB] px-4 py-3">
          <div class="text-[10px] font-semibold text-[#374151]">Filters (API ready)</div>
          <div class="mt-2 text-[10px] text-[#6B7280]">
            Yahan aap later specialization/experience/availability filters connect kar sakte ho — UI placeholder ready
            hai.
          </div>
        </div>

        <div class="flex max-h-[360px] flex-col gap-2 overflow-y-auto pr-1">
          <div *ngFor="let ins of visibleAvailableInstructors"
            class="flex w-full flex-col gap-3 rounded-md border border-[#E5E7EB] bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
            <!-- LEFT -->
            <div class="flex min-w-0 items-start gap-3 sm:items-start">
              <div
                class="flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-full bg-[#F3F4F6]">
                <ng-container *ngIf="ins.avatarUrl; else bFallback">
                  <img [src]="ins.avatarUrl" alt="" class="h-10 w-10 object-cover" />
                </ng-container>
                <ng-template #bFallback>
                  <div class="text-[11px] font-semibold text-gray-600">
                    {{ avatarFallback(ins.name) }}
                  </div>
                </ng-template>
              </div>

              <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <div class="truncate text-xs font-semibold text-[#111827]">{{ ins.name }}</div>

                  <span
                    class="inline-flex items-center rounded-full bg-[#DBEAFE] px-2 py-0.5 text-[10px] font-semibold text-[#1D4ED8]">
                    Available
                  </span>
                </div>

                <div class="mt-0.5 truncate text-[10px] text-[#6B7280]">{{ ins.email }}</div>

                <div class="mt-0.5 flex flex-wrap items-center gap-x-3 gap-y-1 text-[10px] text-[#6B7280]">
                  <span class="truncate">Specialization: {{ ins.specialization }}</span>
                </div>

                <div class="mt-0.5 flex flex-wrap items-center gap-x-3 gap-y-1 text-[10px] text-[#6B7280]">
                  <span class="truncate">Availability: {{ ins.availabilityText ?? '—' }}</span>
                </div>

                <div class="mt-2 flex flex-wrap items-center gap-2">
                  <div class="text-[10px] text-[#6B7280]">Preferred Courses:</div>
                  <div class="flex flex-wrap items-center gap-2">
                    <span *ngFor="let c of ins.preferredCourses"
                      class="inline-flex items-center rounded-full bg-[#F3E8FF] px-2 py-0.5 text-[10px] font-semibold text-[#7C3AED]">
                      {{ c }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT -->
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end sm:gap-3">
              <div class="flex items-center justify-between sm:flex-col sm:items-end sm:leading-tight">
                <!-- Removed Static Rating Block -->
              </div>

              <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <button type="button" (click)="openInstructorProfile(ins)"
                  class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-1 rounded-sm bg-[#16A34A] px-4 text-[11px] font-semibold text-white hover:opacity-95 sm:h-7 sm:w-auto sm:text-[10px]">
                  <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                  Assign to Course
                </button>

                <button type="button"
                  class="inline-flex h-9 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#374151] px-4 text-[11px] font-semibold text-white hover:opacity-95 sm:h-7 sm:w-auto sm:text-[10px]">
                  <svg class="h-3.5 w-3.5 text-white/90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z" stroke="currentColor" stroke-width="2" />
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" stroke="currentColor" stroke-width="2" />
                  </svg>
                  View Profile
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!--  BAR (PIXEL PERFECT like image) -->
    <section class=" mt-4 bg-transparent px-6 pb-2">
      <div
        class="flex w-full flex-col gap-3 rounded-sm bg-white px-4 py-4 shadow-[0_8px_20px_rgba(17,24,39,0.12)] sm:px-6 lg:flex-row lg:items-center lg:justify-between">
        <!-- Left: Progress -->
        <div class="flex items-start gap-3 sm:items-center">
          <div
            class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-[#923D8C1A] text-xs font-semibold text-[#923D8C]">
            {{ overallCompletionPercent }}%
          </div>

          <div class="flex min-w-0 flex-col leading-tight">
            <div class="text-xs font-semibold text-[#111827]">Course Completion</div>
            <div class="mt-0.5 text-[10px] text-[#6B7280]">
              {{ requiredFieldsRemaining }} required fields remaining
            </div>
          </div>
        </div>

        <!-- Right: Actions -->
        <div class="flex w-full flex-col gap-2 sm:flex-row sm:items-center sm:justify-end lg:w-auto">
          <button type="button" (click)="discardChanges()"
            class="inline-flex h-10 w-full cursor-pointer items-center justify-center rounded-sm border border-transparent bg-transparent px-4 text-xs font-medium text-[#6B7280] hover:text-[#111827] sm:h-9 sm:w-auto">
            Discard Changes
          </button>

          <button type="button" (click)="onPreviewCourse()"
            class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm border border-[#E5E7EB] bg-white px-4 text-xs font-medium text-[#374151] hover:bg-[#F9FAFB] sm:h-9 sm:w-auto">
            <svg class="h-4 w-4 text-[#6B7280]" viewBox="0 0 24 24" fill="none">
              <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="1.8" />
              <path d="M12 15a3 3 0 1 0 0-6" stroke="currentColor" stroke-width="1.8" />
            </svg>
            <span class="whitespace-nowrap">Preview Course</span>
          </button>

          <button type="button" (click)="onSaveDraft()"
            class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm border border-[#E5E7EB] bg-white px-4 text-xs font-medium text-[#374151] hover:bg-[#F9FAFB] sm:h-9 sm:w-auto">
            <svg class="h-4 w-4 text-[#6B7280]" viewBox="0 0 24 24" fill="none">
              <path d="M7 3h10l4 4v14H3V3h4Z" stroke="currentColor" stroke-width="1.8" />
              <path d="M7 3v8h10V3" stroke="currentColor" stroke-width="1.8" />
            </svg>
            <span class="whitespace-nowrap">Save Draft</span>
          </button>

          <button type="button" (click)="onPublishCourse()"
            class="inline-flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-sm bg-[#923D8C] px-5 text-xs font-semibold text-white hover:bg-[#6B2472] sm:h-9 sm:w-auto">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none">
              <path d="M20 7 10 17l-5-5" stroke="currentColor" stroke-width="2" />
            </svg>
            <span class="whitespace-nowrap">Publish Course</span>
          </button>
        </div>
      </div>
    </section>

    <!-- ===================== PROFILE MODAL ===================== -->
    <div *ngIf="showInstructorProfileModal && profileInstructor"
      class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/50 px-3 sm:px-4" role="dialog"
      aria-modal="true">
      <div
        class="relative w-full max-w-[520px] rounded-2xl bg-white px-5 pt-10 pb-8 shadow-[0_18px_45px_rgba(0,0,0,0.28)] sm:px-6">
        <button type="button" (click)="closeInstructorProfile()"
          class="absolute right-4 top-4 inline-flex h-9 w-9 cursor-pointer items-center justify-center rounded-full text-[#111827] hover:bg-[#F3F4F6]"
          aria-label="Close">
          ✕
        </button>

        <div class="flex flex-col items-center">
          <div
            class="-mt-16 flex h-[74px] w-[74px] items-center justify-center rounded-full border-[3px] border-[#7C1F6A] bg-white shadow-[0_8px_18px_rgba(0,0,0,0.12)]">
            <div class="flex h-[62px] w-[62px] items-center justify-center overflow-hidden rounded-full bg-[#E5E7EB]">
              <ng-container *ngIf="profileInstructor.avatarUrl; else pFallback">
                <img [src]="profileInstructor.avatarUrl" alt="" class="h-[62px] w-[62px] object-cover" />
              </ng-container>
              <ng-template #pFallback>
                <div class="text-sm font-semibold text-gray-600">
                  {{ avatarFallback(profileInstructor.name) }}
                </div>
              </ng-template>
            </div>
          </div>

          <div class="mt-4 w-full text-center">
            <div class="break-words text-[22px] font-semibold text-[#111827] sm:text-[28px]">
              {{ profileInstructor.name }}
            </div>
            <div class="mt-1 break-words text-[14px] font-semibold text-[#2563EB] sm:text-lg">
              {{ profileInstructor.email }}
            </div>
            <div class="mt-2 break-words text-[16px] font-semibold text-[#111827] sm:text-[22px]">
              Skills | <span class="font-normal">{{ profileInstructor.skillsLine }}</span>
            </div>
          </div>

          <button type="button" (click)="onProfilePrimaryClick()"
            class="mt-6 inline-flex h-11 w-full cursor-pointer items-center justify-center rounded-sm bg-[#7C1F6A] px-6 text-[13px] font-semibold text-white hover:bg-[#6B175C] sm:w-auto sm:px-10">
            {{ profilePrimaryBtnText }}
          </button>
        </div>
      </div>
    </div>

    <!-- ===================== CONFIRM MODAL ===================== -->
    <div *ngIf="showInstructorConfirmModal && confirmInstructor"
      class="fixed inset-0 z-[2100] flex items-center justify-center bg-black/50 px-3 sm:px-4" role="dialog"
      aria-modal="true">
      <div class="w-full max-w-[760px] rounded-2xl bg-white px-5 py-10 shadow-[0_18px_45px_rgba(0,0,0,0.28)] sm:px-6">
        <div class="text-center text-[18px] font-semibold text-[#111827] sm:text-[22px]">
          {{ confirmTitleText }}
        </div>

        <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-center sm:gap-6">
          <button type="button" (click)="closeConfirm()"
            class="inline-flex h-11 w-full cursor-pointer items-center justify-center rounded-sm border border-[#D1D5DB] bg-white px-10 text-[13px] font-semibold text-[#6B7280] hover:bg-[#F9FAFB] sm:w-auto">
            Cancel
          </button>

          <button type="button" (click)="confirmYes()"
            class="inline-flex h-11 w-full cursor-pointer items-center justify-center rounded-sm bg-[#7C1F6A] px-10 text-[13px] font-semibold text-white hover:bg-[#6B175C] sm:w-auto">
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Status Modal (Toast) -->
    <app-status-modal [show]="showModal" [title]="modalTitle" [message]="modalMessage" [type]="modalType"
      (close)="closeModal()">
    </app-status-modal>

    <!-- Rename Modal -->
    <div [style.display]="showRenameModal ? 'flex' : 'none'"
      class="fixed inset-0 z-[1100] items-center justify-center bg-black/50 px-3">
      <div class="w-full max-w-[400px] overflow-hidden rounded-lg bg-white shadow-[0_20px_60px_rgba(0,0,0,0.25)]">
        <div class="flex items-center justify-between border-b border-gray-100 px-5 py-4">
          <h3 class="text-[16px] font-semibold text-[#111827]">Rename File</h3>
          <button type="button" (click)="closeRenameModal()" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <div class="px-5 py-5">
          <label class="text-[11px] font-semibold text-gray-500 uppercase tracking-wider">New Filename</label>
          <input #renameInput type="text" [(ngModel)]="renameInputValue" (keyup.enter)="!isRenaming && saveRename()"
            [disabled]="isRenaming"
            class="mt-2 h-10 w-full rounded-md border border-gray-200 bg-[#F9FAFB] px-3 text-[13px] text-gray-700 outline-none focus:border-[#7C1F6A] focus:bg-white transition-all disabled:opacity-50"
            placeholder="Enter new name..." />
        </div>

        <div class="flex items-center justify-end gap-3 bg-[#F9FAFB] px-5 py-4">
          <button type="button" (click)="closeRenameModal()" [disabled]="isRenaming"
            class="h-9 rounded-md px-4 text-[12px] font-medium text-gray-600 hover:bg-gray-200 transition-colors disabled:opacity-50">
            Cancel
          </button>
          <button type="button" (click)="saveRename()" [disabled]="isRenaming"
            class="inline-flex h-9 items-center justify-center rounded-md bg-[#7C1F6A] px-5 text-[12px] font-semibold text-white hover:bg-[#6B175C] shadow-sm transition-all disabled:opacity-50">
            <span *ngIf="isRenaming"
              class="mr-2 h-3.5 w-3.5 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
            {{ isRenaming ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>